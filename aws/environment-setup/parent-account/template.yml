AWSTemplateFormatVersion: "2010-09-09"

Parameters:

  ParentAccountId:
    Type: String
    MaxLength: 12
    MinLength: 12
  ChildAccounts:
    Type: CommaDelimitedList
  OrganisationId:
    Type: String
    AllowedPattern: ^o-[a-z0-9]{10,32}$

Resources: 

  AllAccountAdminUser:
    Type: AWS::IAM::User
    Properties:
      UserName: AllAccountAdminUser
      Groups:
        - !Ref AllAccountAdminGroup

  AllAccountAdminGroup: 
    Type: "AWS::IAM::Group"
    Properties: 
      ManagedPolicyArns: 
        - !Ref AllAccountAdminPolicy

  AllAccountAdminPolicy: 
    Type: "AWS::IAM::ManagedPolicy"
    Properties: 
      PolicyDocument: 
        Version: "2012-10-17"
        Statement: 
          - 
            # admin permissions on 'this' account (i.e. the parent account)
            Effect: "Allow"
            Action: 
              - "*"
            Resource: "*"
          - 
            # admin permissions on each child account
            Effect: "Allow"
            Action: 
              - "sts:AssumeRole"
            Resource: !Split [ ",", !Join [ "", ["arn:aws:iam::", !Join [ ":role/OrganizationAccountAccessRole,arn:aws:iam::", !Ref ChildAccounts ], ":role/OrganizationAccountAccessRole"]]]

  CloudTrailLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      PublicAccessBlockConfiguration: 
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      LifecycleConfiguration: 
        Rules: 
          - Id: CleanUp
            AbortIncompleteMultipartUpload: 
              DaysAfterInitiation: 2
            Status: Enabled
            #also "Clean up expired object delete markers" not in cf yet - https://github.com/aws-cloudformation/aws-cloudformation-coverage-roadmap/issues/132
  CloudTrailLogsBucketPolicy: 
    Type: AWS::S3::BucketPolicy
    Properties: 
      Bucket: 
        Ref: CloudTrailLogsBucket
      PolicyDocument: 
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - cloudtrail.amazonaws.com
          Action: s3:GetBucketAcl
          Resource: !GetAtt CloudTrailLogsBucket.Arn
        - Effect: Allow
          Principal:
            Service:
            - cloudtrail.amazonaws.com
          Action: s3:PutObject
          # we don't actually expect to write anything to this path, but cloud trail checks for it, so it has to be there
          Resource: !Sub "${CloudTrailLogsBucket.Arn}/AWSLogs/${ParentAccountId}/*"
          Condition:
            StringEquals:
              s3:x-amz-acl: bucket-owner-full-control
        - Effect: Allow
          Principal:
            Service:
            - cloudtrail.amazonaws.com
          Action: s3:PutObject
          Resource: !Sub "${CloudTrailLogsBucket.Arn}/AWSLogs/${OrganisationId}/*"
          Condition:
            StringEquals:
              s3:x-amz-acl: bucket-owner-full-control

# also turn on billing access via IAM - https://console.aws.amazon.com/billing/home?#/account / IAM User and Role Access to Billing Information / Edit / Activate IAM Access / Update

Outputs:
  GoHere: 
    Value: !Sub "Now create a password for ${AllAccountAdminUser}: https://console.aws.amazon.com/iam/home#/users/${AllAccountAdminUser}?section=security_credentials"
  CloudTrailCommand1:
    Value: "aws organizations enable-aws-service-access --service-principal cloudtrail.amazonaws.com"
  CloudTrailCommand2:
    # IsOrganizationTrail not supported by cf yet so have to use cli - https://github.com/aws-cloudformation/aws-cloudformation-coverage-roadmap/issues/45
    Value: !Sub "aws cloudtrail create-trail --name all-accounts-management-events --s3-bucket-name ${CloudTrailLogsBucket} --is-organization-trail --is-multi-region-trail"
  CloudTrailCommand3:
    Value: !Sub "aws cloudtrail start-logging --name all-accounts-management-events"
